
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã°ãªãª-tube</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(20, 20, 30, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.7), 0 0 1px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 10px;
            font-size: 3em;
            font-weight: 800;
            letter-spacing: -1px;
        }
        
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 40px;
            font-size: 1em;
            font-weight: 300;
        }
        
        .status {
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.95em;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        
        .status.loading {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border-color: rgba(255, 193, 7, 0.3);
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border-color: rgba(76, 175, 80, 0.3);
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border-color: rgba(244, 67, 54, 0.3);
        }
        
        .status.info {
            background: rgba(33, 150, 243, 0.1);
            color: #2196f3;
            border-color: rgba(33, 150, 243, 0.3);
        }
        
        .search-section {
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 16px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 16px;
            color: #e0e0e0;
            transition: all 0.3s ease;
        }
        
        input[type="text"]::placeholder {
            color: #666;
        }
        
        input[type="text"]:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            padding: 16px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: rgba(100, 100, 100, 0.3);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            background: transparent;
            color: #888;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: none;
        }
        
        .tab:hover {
            color: #aaa;
            background: rgba(255, 255, 255, 0.05);
            transform: none;
        }
        
        .tab.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .video-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .video-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.3);
        }
        
        .video-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #1a1a2e;
        }
        
        .video-info {
            padding: 18px;
        }
        
        .video-title {
            font-weight: 700;
            color: #f0f0f0;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-size: 1.05em;
            line-height: 1.4;
        }
        
        .video-author {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .video-stats {
            color: #666;
            font-size: 0.85em;
            font-weight: 400;
        }
        
        .player-section {
            margin-top: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .player-section.active {
            display: block;
        }
        
        video {
            width: 100%;
            max-height: 600px;
            background: #000;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .player-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #f0f0f0;
            margin: 20px 0;
            line-height: 1.4;
        }
        
        .player-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .quality-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .quality-selector label {
            font-weight: 600;
            color: #aaa;
            font-size: 0.95em;
        }
        
        .quality-selector select {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 14px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quality-selector select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .instance-info {
            font-size: 0.9em;
            color: #888;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .instance-selector {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .instance-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #aaa;
            font-size: 0.95em;
        }
        
        select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 14px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 1.2em;
            font-weight: 500;
        }
        
        .retry-info {
            font-size: 0.9em;
            color: #888;
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #888;
            margin-top: 5px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ã°ãªãª-tube</h1>
        <div class="subtitle">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦– â€¢ é«˜é€Ÿä¸¦åˆ—å–å¾— â€¢ è‡ªå‹•æœ€é©åŒ–</div>
        
        <div id="status" class="status loading">
            <span class="loading-spinner"></span> ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èª­ã¿è¾¼ã¿ä¸­...
        </div>
        
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="instanceCount">0</div>
                <div class="stat-label">ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgSpeed">0ms</div>
                <div class="stat-label">å¹³å‡é€Ÿåº¦</div>
            </div>
        </div>
        
        <div class="instance-selector">
            <label for="instanceSelect">ğŸŒ Invidiousã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆè‡ªå‹•é¸æŠ / æ‰‹å‹•é¸æŠï¼‰</label>
            <select id="instanceSelect"></select>
        </div>
        
        <div class="search-section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('search')">ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</button>
                <button class="tab" onclick="switchTab('url')">ğŸ”— YouTube URL</button>
            </div>
            
            <div id="searchTab" class="tab-content active">
                <div class="input-group">
                    <input type="text" id="searchInput" placeholder="å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..." />
                    <button id="searchBtn" onclick="searchVideos()">æ¤œç´¢</button>
                </div>
            </div>
            
            <div id="urlTab" class="tab-content">
                <div class="input-group">
                    <input type="text" id="urlInput" placeholder="https://www.youtube.com/watch?v=... ã¾ãŸã¯å‹•ç”»ID" />
                    <button id="urlBtn" onclick="playFromUrl()">å†ç”Ÿ</button>
                </div>
            </div>
        </div>
        
        <div id="videoGrid" class="video-grid"></div>
        
        <div id="playerSection" class="player-section">
            <video id="videoPlayer" controls></video>
            <div class="player-title" id="playerTitle"></div>
            <div class="player-controls">
                <div class="quality-selector">
                    <label for="qualitySelect">ç”»è³ª:</label>
                    <select id="qualitySelect">
                        <option value="">è‡ªå‹•é¸æŠ</option>
                    </select>
                </div>
                <div class="instance-info" id="currentInstanceInfo"></div>
            </div>
            <div class="retry-info" id="retryInfo"></div>
        </div>
    </div>

    <script>
        let instances = [];
        let currentInstance = '';
        let currentVideoData = null;
        let currentVideoId = null;
        let availableQualities = [];
        let stats = { totalRequests: 0, successRequests: 0, totalTime: 0 };

        async function loadInstances() {
            try {
                const allInstances = [
                    { name: 'inv.nadeko.net', url: 'https://inv.nadeko.net', region: 'CL', flag: 'ğŸ‡¨ğŸ‡±' },
                    { name: 'invidious.nerdvpn.de', url: 'https://invidious.nerdvpn.de', region: 'UA', flag: 'ğŸ‡ºğŸ‡¦' },
                    { name: 'invidious.f5.si', url: 'https://invidious.f5.si', region: 'JP', flag: 'ğŸ‡¯ğŸ‡µ' },
                    { name: 'inv.perditum.com', url: 'https://inv.perditum.com', region: 'AL', flag: 'ğŸ‡¦ğŸ‡±' },
                    { name: 'yewtu.be', url: 'https://yewtu.be', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'vid.puffyan.us', url: 'https://vid.puffyan.us', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'yt.artemislena.eu', url: 'https://yt.artemislena.eu', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'invidious.flokinet.to', url: 'https://invidious.flokinet.to', region: 'RO', flag: 'ğŸ‡·ğŸ‡´' },
                    { name: 'invidious.projectsegfau.lt', url: 'https://invidious.projectsegfau.lt', region: 'FR', flag: 'ğŸ‡«ğŸ‡·' },
                    { name: 'inv.bp.projectsegfau.lt', url: 'https://inv.bp.projectsegfau.lt', region: 'LU', flag: 'ğŸ‡±ğŸ‡º' },
                    { name: 'invidious.tiekoetter.com', url: 'https://invidious.tiekoetter.com', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'invidious.slipfox.xyz', url: 'https://invidious.slipfox.xyz', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'inv.pistasjis.net', url: 'https://inv.pistasjis.net', region: 'FR', flag: 'ğŸ‡«ğŸ‡·' },
                    { name: 'invidious.privacydev.net', url: 'https://invidious.privacydev.net', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'vid.priv.au', url: 'https://vid.priv.au', region: 'SG', flag: 'ğŸ‡¸ğŸ‡¬' },
                    { name: 'iv.melmac.space', url: 'https://iv.melmac.space', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'invidious.io.lol', url: 'https://invidious.io.lol', region: 'SG', flag: 'ğŸ‡¸ğŸ‡¬' },
                    { name: 'inv.riverside.rocks', url: 'https://inv.riverside.rocks', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.baczek.me', url: 'https://invidious.baczek.me', region: 'PL', flag: 'ğŸ‡µğŸ‡±' },
                    { name: 'y.com.sb', url: 'https://y.com.sb', region: 'NL', flag: 'ğŸ‡³ğŸ‡±' },
                    { name: 'invidious.sethforprivacy.com', url: 'https://invidious.sethforprivacy.com', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.rhyshl.live', url: 'https://invidious.rhyshl.live', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.kavin.rocks', url: 'https://invidious.kavin.rocks', region: 'IN', flag: 'ğŸ‡®ğŸ‡³' },
                    { name: 'invidious.snopyta.org', url: 'https://invidious.snopyta.org', region: 'FI', flag: 'ğŸ‡«ğŸ‡®' },
                    { name: 'invidious.048596.xyz', url: 'https://invidious.048596.xyz', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'vid.mint.lgbt', url: 'https://vid.mint.lgbt', region: 'CA', flag: 'ğŸ‡¨ğŸ‡¦' },
                    { name: 'inv.vern.cc', url: 'https://inv.vern.cc', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.esmailelbob.xyz', url: 'https://invidious.esmailelbob.xyz', region: 'CA', flag: 'ğŸ‡¨ğŸ‡¦' },
                    { name: 'inv.odyssey346.dev', url: 'https://inv.odyssey346.dev', region: 'FR', flag: 'ğŸ‡«ğŸ‡·' },
                    { name: 'invidious.drgns.space', url: 'https://invidious.drgns.space', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.adminforge.de', url: 'https://invidious.adminforge.de', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'inv.us.projectsegfau.lt', url: 'https://inv.us.projectsegfau.lt', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.fdn.fr', url: 'https://invidious.fdn.fr', region: 'FR', flag: 'ğŸ‡«ğŸ‡·' },
                    { name: 'invidious.namazso.eu', url: 'https://invidious.namazso.eu', region: 'RO', flag: 'ğŸ‡·ğŸ‡´' },
                    { name: 'invidious.silur.me', url: 'https://invidious.silur.me', region: 'RO', flag: 'ğŸ‡·ğŸ‡´' },
                    { name: 'inv.citw.lgbt', url: 'https://inv.citw.lgbt', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.privacyredirect.com', url: 'https://invidious.privacyredirect.com', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.jing.rocks', url: 'https://invidious.jing.rocks', region: 'SG', flag: 'ğŸ‡¸ğŸ‡¬' },
                    { name: 'invidious.protokolla.fi', url: 'https://invidious.protokolla.fi', region: 'FI', flag: 'ğŸ‡«ğŸ‡®' },
                    { name: 'invidious.lunar.icu', url: 'https://invidious.lunar.icu', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'inv.zzls.xyz', url: 'https://inv.zzls.xyz', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.lidarshield.cloud', url: 'https://invidious.lidarshield.cloud', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'yt.oelrichsgarcia.de', url: 'https://yt.oelrichsgarcia.de', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'iv.nboeck.de', url: 'https://iv.nboeck.de', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'invidious.no-logs.com', url: 'https://invidious.no-logs.com', region: 'AT', flag: 'ğŸ‡¦ğŸ‡¹' },
                    { name: 'tube.cthd.icu', url: 'https://tube.cthd.icu', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.dhusch.de', url: 'https://invidious.dhusch.de', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'invidious.materialio.us', url: 'https://invidious.materialio.us', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.zapashcanon.fr', url: 'https://invidious.zapashcanon.fr', region: 'FR', flag: 'ğŸ‡«ğŸ‡·' },
                    { name: 'inv.tux.pizza', url: 'https://inv.tux.pizza', region: 'FI', flag: 'ğŸ‡«ğŸ‡®' },
                    { name: 'invidious.private.coffee', url: 'https://invidious.private.coffee', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'yt.drgnz.club', url: 'https://yt.drgnz.club', region: 'FR', flag: 'ğŸ‡«ğŸ‡·' },
                    { name: 'inv.in.projectsegfau.lt', url: 'https://inv.in.projectsegfau.lt', region: 'IN', flag: 'ğŸ‡®ğŸ‡³' },
                    { name: 'invidious.einfachzocken.eu', url: 'https://invidious.einfachzocken.eu', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'iv.ggtyler.dev', url: 'https://iv.ggtyler.dev', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'invidious.asir.dev', url: 'https://invidious.asir.dev', region: 'US', flag: 'ğŸ‡ºğŸ‡¸' },
                    { name: 'iv.nboeck.de', url: 'https://iv.nboeck.de', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'yt.cdaut.de', url: 'https://yt.cdaut.de', region: 'DE', flag: 'ğŸ‡©ğŸ‡ª' },
                    { name: 'invidious.fdn.fr', url: 'https://invidious.fdn.fr', region: 'FR', flag: 'ğŸ‡«ğŸ‡·' },
                    { name: 'invidious.perennialte.ch', url: 'https://invidious.perennialte.ch', region: 'CH', flag: 'ğŸ‡¨ğŸ‡­' }
                ];
                
                try {
                    const response = await fetch('https://api.invidious.io/instances.json');
                    const data = await response.json();
                    
                    const apiInstances = data
                        .filter(([name, info]) => info.type === 'https')
                        .map(([name, info]) => ({
                            name: name,
                            url: info.uri,
                            region: info.region,
                            flag: info.flag
                        }));
                    
                    const combined = [...apiInstances, ...allInstances];
                    const uniqueMap = new Map();
                    combined.forEach(inst => {
                        if (!uniqueMap.has(inst.url)) {
                            uniqueMap.set(inst.url, inst);
                        }
                    });
                    instances = Array.from(uniqueMap.values());
                } catch (apiError) {
                    console.warn('APIèª­ã¿è¾¼ã¿å¤±æ•—ã€æ‰‹å‹•ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨:', apiError);
                    instances = allInstances;
                }
                
                if (instances.length === 0) {
                    throw new Error('åˆ©ç”¨å¯èƒ½ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                const select = document.getElementById('instanceSelect');
                const autoOption = document.createElement('option');
                autoOption.value = 'auto';
                autoOption.textContent = 'âš¡ è‡ªå‹•é¸æŠï¼ˆæœ€é€Ÿã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¸¦åˆ—æ¤œç´¢ï¼‰';
                select.appendChild(autoOption);
                
                instances.forEach((instance) => {
                    const option = document.createElement('option');
                    option.value = instance.url;
                    option.textContent = `${instance.flag || ''} ${instance.name} (${instance.region || 'Unknown'})`;
                    select.appendChild(option);
                });
                
                select.value = 'auto';
                currentInstance = 'auto';
                
                select.addEventListener('change', (e) => {
                    currentInstance = e.target.value;
                });
                
                document.getElementById('instanceCount').textContent = instances.length;
                document.getElementById('status').className = 'status success';
                document.getElementById('status').innerHTML = `âœ… ${instances.length}å€‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆä¸¦åˆ—é«˜é€Ÿå–å¾—å¯¾å¿œï¼‰`;
                
            } catch (error) {
                console.error('ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = 'âŒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
            }
        }

        async function raceInstances(operation, operationName, maxParallel = 10) {
            const retryInfo = document.getElementById('retryInfo');
            if (retryInfo) {
                retryInfo.textContent = `${operationName}ä¸­... ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡`;
            }
            
            const startTime = Date.now();
            
            return new Promise((resolve, reject) => {
                let completed = false;
                let errorCount = 0;
                let lastError = null;
                
                const tryBatch = async (batch) => {
                    const promises = batch.map(async (instance, index) => {
                        try {
                            const result = await operation(instance.url);
                            
                            if (!completed) {
                                completed = true;
                                const time = Date.now() - startTime;
                                stats.totalRequests++;
                                stats.successRequests++;
                                stats.totalTime += time;
                                
                                currentInstance = instance.url;
                                document.getElementById('instanceSelect').value = instance.url;
                                
                                if (retryInfo) {
                                    retryInfo.textContent = `âœ… æˆåŠŸ: ${instance.flag} ${instance.name} (${time}ms)`;
                                }
                                
                                updateStats();
                                resolve(result);
                            }
                            return result;
                        } catch (error) {
                            errorCount++;
                            lastError = error;
                            console.warn(`${instance.name} ã§å¤±æ•—:`, error.message);
                            return null;
                        }
                    });
                    
                    await Promise.all(promises);
                };
                
                const runBatches = async () => {
                    for (let i = 0; i < instances.length; i += maxParallel) {
                        if (completed) break;
                        const batch = instances.slice(i, i + maxParallel);
                        await tryBatch(batch);
                    }
                    
                    if (!completed) {
                        stats.totalRequests++;
                        if (retryInfo) {
                            retryInfo.textContent = `âŒ ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å¤±æ•—ã—ã¾ã—ãŸ (${errorCount}/${instances.length})`;
                        }
                        updateStats();
                        reject(lastError || new Error('ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å¤±æ•—ã—ã¾ã—ãŸ'));
                    }
                };
                
                runBatches();
            });
        }

        function updateStats() {
            const successRate = stats.totalRequests > 0 
                ? Math.round((stats.successRequests / stats.totalRequests) * 100) 
                : 0;
            const avgSpeed = stats.successRequests > 0 
                ? Math.round(stats.totalTime / stats.successRequests) 
                : 0;
            
            document.getElementById('successRate').textContent = `${successRate}%`;
            document.getElementById('avgSpeed').textContent = `${avgSpeed}ms`;
        }

        async function searchVideos() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const btn = document.getElementById('searchBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> æ¤œç´¢ä¸­...';
            
            const videoGrid = document.getElementById('videoGrid');
            videoGrid.innerHTML = '';
            
            const statusEl = document.getElementById('status');
            statusEl.className = 'status info';
            statusEl.innerHTML = 'ğŸ” ä¸¦åˆ—æ¤œç´¢å®Ÿè¡Œä¸­...';
            
            try {
                const videos = await raceInstances(async (instanceUrl) => {
                    const url = `${instanceUrl}/api/v1/search?q=${encodeURIComponent(query)}&type=video`;
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 8000);
                    
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeout);
                    
                    if (!response.ok) {
                        throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                    
                    return await response.json();
                }, 'æ¤œç´¢', 15);
                
                if (!videos || videos.length === 0) {
                    videoGrid.innerHTML = '<div class="no-results">æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
                    statusEl.className = 'status';
                    statusEl.style.display = 'none';
                    return;
                }
                
                videos.slice(0, 16).forEach(video => {
                    const card = createVideoCard(video);
                    videoGrid.appendChild(card);
                });
                
                statusEl.className = 'status success';
                statusEl.innerHTML = `âœ… ${videos.slice(0, 16).length}ä»¶ã®å‹•ç”»ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ`;
                
            } catch (error) {
                console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                statusEl.className = 'status error';
                statusEl.innerHTML = 'âŒ æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ';
                videoGrid.innerHTML = '<div class="no-results">æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'video-card';
            card.onclick = () => playVideoById(video.videoId, video.title);
            
            const thumbnail = video.videoThumbnails?.[0]?.url || '';
            const title = video.title || 'ç„¡é¡Œ';
            const author = video.author || 'ä¸æ˜';
            const views = formatViews(video.viewCount);
            const length = formatDuration(video.lengthSeconds);
            
            card.innerHTML = `
                <img class="video-thumbnail" src="${thumbnail}" alt="${title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22320%22 height=%22200%22%3E%3Crect fill=%22%231a1a2e%22 width=%22320%22 height=%22200%22/%3E%3Ctext fill=%22%23666%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22%3Eç”»åƒãªã—%3C/text%3E%3C/svg%3E'">
                <div class="video-info">
                    <div class="video-title">${escapeHtml(title)}</div>
                    <div class="video-author">${escapeHtml(author)}</div>
                    <div class="video-stats">${views} è¦–è´ â€¢ ${length}</div>
                </div>
            `;
            
            return card;
        }

        async function playFromUrl() {
            const urlInput = document.getElementById('urlInput').value.trim();
            if (!urlInput) {
                alert('YouTube URLã¾ãŸã¯å‹•ç”»IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            let videoId = urlInput;
            
            const urlMatch = urlInput.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            if (urlMatch) {
                videoId = urlMatch[1];
            }
            
            if (videoId.length !== 11) {
                alert('æœ‰åŠ¹ãªYouTube URLã¾ãŸã¯11æ–‡å­—ã®å‹•ç”»IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            playVideoById(videoId);
        }

        async function playVideoById(videoId, title = '') {
            const playerSection = document.getElementById('playerSection');
            const videoPlayer = document.getElementById('videoPlayer');
            const playerTitle = document.getElementById('playerTitle');
            const qualitySelect = document.getElementById('qualitySelect');
            const currentInstanceInfo = document.getElementById('currentInstanceInfo');
            const retryInfo = document.getElementById('retryInfo');
            
            currentVideoId = videoId;
            playerTitle.textContent = title || `å‹•ç”»ID: ${videoId}`;
            playerSection.classList.add('active');
            playerSection.scrollIntoView({ behavior: 'smooth' });
            
            retryInfo.textContent = 'å‹•ç”»æƒ…å ±ã‚’ä¸¦åˆ—å–å¾—ä¸­...';
            
            try {
                currentVideoData = await raceInstances(async (instanceUrl) => {
                    const url = `${instanceUrl}/api/v1/videos/${videoId}`;
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 10000);
                    
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeout);
                    
                    if (!response.ok) {
                        throw new Error(`å‹•ç”»æƒ…å ±ã®å–å¾—ã«å¤±æ•—: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.adaptiveFormats && !data.formatStreams) {
                        throw new Error('ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    return data;
                }, 'å‹•ç”»æƒ…å ±å–å¾—', 15);
                
                if (currentVideoData.title && !title) {
                    playerTitle.textContent = currentVideoData.title;
                }
                
                const instanceName = instances.find(i => i.url === currentInstance)?.name || currentInstance;
                currentInstanceInfo.textContent = `ä½¿ç”¨ä¸­: ${instanceName}`;
                
                populateQualityOptions();
                
                const selectedQuality = qualitySelect.value;
                loadVideoWithQuality(selectedQuality);
                
            } catch (error) {
                console.error('å‹•ç”»å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                retryInfo.textContent = 'âŒ å‹•ç”»ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
                alert('å‹•ç”»ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®å‹•ç”»ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function populateQualityOptions() {
            const qualitySelect = document.getElementById('qualitySelect');
            qualitySelect.innerHTML = '<option value="">è‡ªå‹•é¸æŠï¼ˆæœ€é«˜ç”»è³ªï¼‰</option>';
            
            const formats = [
                ...(currentVideoData.adaptiveFormats || []),
                ...(currentVideoData.formatStreams || [])
            ];
            
            availableQualities = [];
            
            const qualityMap = new Map();
            formats.forEach(format => {
                const isVideo = format.type?.includes('video');
                const hasAudio = format.type?.includes('audio') || format.audioQuality;
                
                if (format.qualityLabel && (isVideo || hasAudio)) {
                    const key = format.qualityLabel;
                    if (!qualityMap.has(key) || (hasAudio && !qualityMap.get(key).hasAudio)) {
                        qualityMap.set(key, { ...format, hasAudio });
                    }
                }
            });
            
            const sortedQualities = Array.from(qualityMap.entries()).sort((a, b) => {
                const aHeight = parseInt(a[0]) || 0;
                const bHeight = parseInt(b[0]) || 0;
                return bHeight - aHeight;
            });
            
            sortedQualities.forEach(([label, format]) => {
                availableQualities.push({ label, format });
                const option = document.createElement('option');
                option.value = label;
                option.textContent = `${label}${format.hasAudio ? ' (éŸ³å£°ã‚ã‚Š)' : ''}`;
                qualitySelect.appendChild(option);
            });
            
            qualitySelect.onchange = () => {
                loadVideoWithQuality(qualitySelect.value);
            };
        }

        function loadVideoWithQuality(quality) {
            const videoPlayer = document.getElementById('videoPlayer');
            const retryInfo = document.getElementById('retryInfo');
            
            let videoUrl = '';
            
            if (quality) {
                const selected = availableQualities.find(q => q.label === quality);
                if (selected) {
                    videoUrl = selected.format.url;
                }
            } else {
                const preferredQualities = ['1080p', '720p', '480p', '360p', '240p'];
                
                for (const qual of preferredQualities) {
                    const format = availableQualities.find(q => q.label === qual);
                    if (format) {
                        videoUrl = format.format.url;
                        break;
                    }
                }
                
                if (!videoUrl && availableQualities.length > 0) {
                    videoUrl = availableQualities[0].format.url;
                }
            }
            
            if (!videoUrl) {
                retryInfo.textContent = 'âŒ å†ç”Ÿå¯èƒ½ãªå‹•ç”»ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                return;
            }
            
            const currentTime = videoPlayer.currentTime || 0;
            videoPlayer.src = videoUrl;
            videoPlayer.load();
            
            videoPlayer.addEventListener('loadedmetadata', () => {
                if (currentTime > 0) {
                    videoPlayer.currentTime = currentTime;
                }
            }, { once: true });
            
            videoPlayer.play().catch(e => {
                console.error('å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
            });
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            if (tab === 'search') {
                tabs[0].classList.add('active');
                document.getElementById('searchTab').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('urlTab').classList.add('active');
            }
        }

        function formatViews(count) {
            if (!count) return '0';
            if (count >= 10000000) return Math.floor(count / 10000000) + 'åƒä¸‡';
            if (count >= 1000000) return Math.floor(count / 10000) + 'ä¸‡';
            if (count >= 1000) return Math.floor(count / 1000) + 'åƒ';
            return count.toString();
        }

        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchVideos();
            }
        });

        document.getElementById('urlInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                playFromUrl();
            }
        });

        loadInstances();
    </script>
</body>
</html>
